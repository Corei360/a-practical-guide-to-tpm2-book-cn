# 开关机和初始配置
启动在这里被定义为每次系统启动时需要做的软件操作。系统启动可以是冷启动，或者是PC相关的从睡眠中唤醒，或者从休眠中重新启动。TPM内部有几种易失性的状态，包括PCR值，已加载的会话和密钥，使能配置，授权和Policy信息，混合NV索引，以及时钟状态。根据TPM电源周期类型的不同，这些易失性状态可能必须被保留或者重新初始化。TPM提供了两个命令，它们可以有各种组合，这允许外部软件来处理TPM电源周期相关的要求。

与上述的情况相反，初始配置是极少发生的事情。它很可能在整个平台声明周期中只发生一次。一个TPM厂商，平台厂商，IT部门，或者终端用户会生成密钥以及其他秘密信息，注入证书，以及使能或者关闭特定的TPM功能。配置的另外一面就是取消配置：在将平台用作他用，变卖，或者丢弃之前需要保证TPM相关的秘密信息都被擦除了。

这一章首先讨论启动，之后是TPM相关的各方可能会做的初始配置。配置方包括TPM厂商，平台厂商（也叫做OEM），以及终端用户（个人或者IT部门）。

## 启动和关闭
TPM的启动和关闭都由底层软件来管理。在一个PC平台上，底层软件是指BIOS（UEFI）和操作系统。管理的主要目的是相关的状态需要按照要求被复位或者恢复，从而使得应用不用关系这些事件的发生。举例来说，一个应用不希望已经加载过的密钥或者会话突然消失了。这个应用可能不能重新加载密钥，并且它也不希望因为会话突然消失而重新运行一个Policy检查。在启动软件和操作系统的支持下，TPM可以让电源周期对应用软件透明，具体的做法就是在掉电时将易失性状态保存到非易失性内存中，重新上电后将这些状态恢复。

TPM规范定义了三种启动事件：TPM复位，TPM恢复，以及TPM重启。这些信号在平台复位时的TPM Init信号之后发生。在一个典型的硬件TPM实现中，初始化就是释放TPM的复位引脚，这很可能是在一个电源周期之后。这时候，我们假设TPM的易失性状态都会丢失，只有之前保存的非易失性状态仍存在于TPM中。

TPM复位通常在平台上电后的启动阶段或者不断电重启时发生。TPM会收到一个启动命令，这个命令用于复位TPM的易失性状态。在这种情况下，复位可以理解为讲一些状态设置为指定的初始化值或者为nonce分配新的随机值。TPM复位将会建立一个新的可信平台状态。所有需要的软件都会被测量并扩展到一组复位PCR中。所有的TPM资源都会被复位到默认的初始配置状态。

TPM恢复通常平台由挂起状态恢复的时候发生，有时候挂起又叫做睡眠或者低功耗状态。因为平台是在继续执行而不是重新启动，所以是所有的状态，包括PCR值，都会被恢复。TPM恢复会将TPM的状体恢复到TPM因为系统睡眠或者重启而掉电前的状态，因为从系统复位或者掉电的时刻起，它的可信状态就没有变化了。

TPM重启通常在平台由休眠状态被唤醒的时候发生。系统休眠时会在TPM断电之前向TPM发送命令来保存状态，大部分的状态都会在TPM启动的时候恢复。例外是PCR的值，PCR在TPM启动时只做了初始化，而不是状态恢复。这个操作就允许平台在启动（由休眠状态恢复）时向PCR扩展新的测量值，而不是将操作系统和应用使用的TPM状态重新恢复到PCR中。TPM重启在PCR操作上是比较特殊的，在这个过程中平台是在重新建立可信状态（会创建新的测量值），而不是恢复相关的可信状态（在这个上下文环境中可以说这些状态就是操作系统和应用程序使用的PCR值）。

TPM提供两个命令来支持上述的启动事件：TPM2_Shutdown和TPM2_Startup命令。关机命令通常是由操作系统在复位或者断电前执行的。TPM2_Shutdown有两个选项：CLEAR和STATE。TPM2_Startup命令通常是在用于系统初始化的固件（比如PC上的BIOS（UEFI））在做RTM（Root of Trust for Measurement）时执行的。TPM2_Startup同样也有两个选项：CLEAR和STATE。

以下是两个命令配合使用的情况：
* TPM复位（重新启动）：TPM2_Shutdown(CLEAR)或者没有TPM2_Shutdown命令，然后执行TPM2_Startup(CLEAR)。
* TPM重启（休眠唤醒）：TPM2_Shutdown(STATE)，然后执行TPM2_Startup(CLEAR)。
* TPM恢复（挂起，睡眠）：TPM2_Shutdown(STATE)，然后执行TPM2_Startup(STATE)。

以下是命令行为的简要描述。这些命令的行为包含很多与时钟，时间，计数器，会话上下文，混合NV索引相关的细节。这些概念已经在本书的其他章节介绍过了：
* TPM2_Shutdown（CLEAR）是平台在关机或者重启时顺序性的关机行为。TPM会将一些易失性的值保存到非易失性内存中：时钟和有顺序属性的NV索引通常会在易失性内存中有一个副本。
* TPM2_Shutdown（STATE）通常是由于系统需要休眠或者挂起而执行的关机操作。TPM会保存之前记录的会话上下文，平台规范强制要求保存的PCR值，一些特定的NV索引标志位，以及审计相关的状态。
* TPM2_Startup（CLEAR）会初始化TPM易失性状态，包括PCR和NV易失性状态；它还会使能三个组织架构；以及清除平台授权和Policy。
* TPM2_Startup（STATE）仅在使用TPM2_Shutdown（STATE）命令关机之后才可以使用。此时PCR会被恢复，或者按照平台相关的规范初始化（0-15保存，16-23初始化）。

举例来说，PCR在上述三种电源周期中的详细行为和原理概括如下：
* 在系统重启时，也就是TPM复位，所有的PCR都必须被初始化。TPM2_Startup（CLEAR）命令总是会初始化PCR的值，不考虑关机的类型。
* 当系统由休眠状态被唤醒时，也就是TPM重启，平台会重新运行BIOS代码并做测量，所以PCR值也必须被初始化。此时使用TPM2_Startup（CLEAR）来初始化PCR，尽管在系统休眠的时候PCR的状态通过TPM2_Shutdown(STATE)被保存了。
* 在系统由睡眠状态被唤醒时，也就是TPM恢复，PCR的值可能在断电时丢失（基本确认会丢失啊，作者是什么意思呢？）。但是因为系统在这种情况下恢复时并不会重新运行BIOS，启动，或者OS初始化代码。所以PCR的值必须被恢复。TPM2_Shutdown（STATE）命令会在系统睡眠之前保存易失性的PCR值。TPM2_Startup（STATE）命令则会恢复这些值。

### 启动时的初始化
## 初始配置
### TPM厂商初始配置
### 平台OEM初始配置
### 终端用户初始配置
### 取消配置
## 总结
