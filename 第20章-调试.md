# 调试
我至今仍记得刚开始使用Z80汇编语言编程时的情景：有好几次，仅仅是为了得到回应，我会吹牛说我能一次就写出没有问题的代码。只需要写出来，编译，瞧，多么完美的程序！说实话，在30多年的工作经历中，结果是我经常被毫无非议地嘲笑了，我从来没有实现过之前吹过的牛皮，很可能永远也不会了

Will Arthur，在写作本章时的回忆。

某个地方的某个人可能写了一个很重要的程序，并且在第一次就成功运行没有任何问题，如果真得存在这种可能，那它也就是存在于统计学上。因为编写程序的过程也可以认为是编写bug的过程，在编程世界中调试需求是永恒不变的规则。

这一章的目的是给你介绍一些用于TPM2.0程序调试和通用调试的特殊工具和方法。我们将主要讨论两个方面的调试：与TPM直接通信的底层软件和使用FAPI和TPM通信的高层次软件。底层应用包含使用ESAPI和SAPI，特殊定制的TSS软件层（如SAPI层），TAB，以及RM的软件。大多数的底层应用调试描述都是直接来自于对应部分作者的底层应用调试经验，这包括SAPI，TAB，RM，以及TPM2.0设备驱动，和所有底层相关的软件。因为现在没有TSS软件栈中FAPI和ESAPI的实现（注：ESAPI已经可以用了哦），所以没有这些方面的调试知识。也正因为如此，这一章的内容都是基于TSS1.2的调试经验，因为我们认为许多问题都是类似的，与版本关系不大。

## 底层应用软件调试
因为我们在TPM2.0方面仅在底层软件上有实际经验，我们先来讨论这些内容。

### 问题
当TPM出现一个错误的时候，它会返回一个错误代码。TPM2.0规范的编写者用心设计了这些有助于调试的错误代码。很多时候，错误代码会告诉你确切的错误原因，但是因为对规范不熟悉，你可能会感到一团糟。在少数情况下，错误代码仅仅提示查找问题的大方向，但是并没有定位错误的具体粒度信息。不论是上面的哪种情况，缺乏具体信息或者是对规范不熟悉，你作为一个经验不多的程序员都会感到不知所措。

这一小节描述了一小部分不同的错误条件，并说明了一个用于调试这些问题的技术框架，由简到繁地介绍如下：
* 错误代码分析：许多简单的错误完全可以通过这种方式调试。
* 分析调试跟踪信息：这就需要检查底层驱动来将发送到TPM的命令字节流和由TPM收到的命令响应数据流。经常发生的情况是，对比正常的跟踪数据和有问题的数据就可以很快定位问题。
* 更加负责的问题：这些问题将需要更多的工作来调试。一个HMAC授权错误可以很快产生一个错误代码，但是调试这个错误需要详细检查计算HMAC的所有步骤。
* 最难调试的错误：这些错误需要深入到TPM2.0模拟器中，并使用调试器单步调试从而理解TPM具体在哪里产生错误。通常情况下，调试TPM模拟器的代码之后，问题的答案就显而易见了。当然，更好地理解规范也有助于发现问题。人类的本性是，我们经常因为森林而分心，从而忘记应该砍下哪一棵树（意思就是我们常常迷失在上千页的规范中，不知所踪）。因此，使用调试器来调试模拟器的技术还是需要的。在Intel开发TPM2.0相关代码的过程中，本小节的作者曾经使用这个方法为自己和同事调试了许多错误。

### 分析错误代码
当你拿到一个错误代码时首先要做的就是解析它。解析的过程在TPM2.0规范第1部分的“Response Code Details”一节有介绍。这一小节中的“Response Code Evaluation”流程图特别有用。

第一个错误案例与TPM2_Startup命令相关。以下的代码片段会产生一个错误（这个代码是第7章中TPM2_Startup测试代码简单修改的版本）：

```
rval = Tss2_Sys_Startup( sysContext, 03 );
CheckPassed(rval);
```

代码在执行CheckPassed时会失败，因为TPM2_Startup命令返回了错误代码0x000001C4而不是TPM2_RC_SUCCESS。根据之前提到的流程图，你可以按照以下方式解析这个错误代码：

```
Bit 8: 1
Bit 7: 1
Bit 6: 1
```

上述这些比特位表示错误码位于比特5：0，并且错误参数在比特11：8中，根据TPM2.0规范第1部分的“TPM_RC Values”小节的描述，具体的错误值是TPM_RC_VALUE。关于这个错误的文字描述是“值超出范围或者在当前上下文中这个值不正确”。这就意味着命令的参数1是错误的。查看TPM2_Startup命令的描述之后，很容易发现，这个命令允许的参数是TPM_SU_CLEAR(0x0000)和TPM_SU_STATE(0x0001)。显然，使用0x3作为命令参数是错误的来源。

我们强烈鼓励大家使用一个解析错误的工具（tpm2-tools工程下已经有很好用的错误解析工具了），因为手动解析错误在反复的调试中很伤脑筋。一个工具的示例输出如下：
```
>tpm2decoderring /e 1c4
ERROR: PARAM #1, TPM_RC_VALUE: value is out of range or is not correct for the context
```
### 调试跟踪分析
### 更多复杂的错误
### 最后的手段
## 常见的问题
## 高层应用软件的调试
### 调使过程
### 典型的问题
#### 授权
#### 被禁用的函数
#### 缺失对象
#### 错误的类型
#### 错误的大小
#### Policy
## 总结
