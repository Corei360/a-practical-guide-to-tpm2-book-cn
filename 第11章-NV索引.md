# NV索引
TPM使用非易失性内存来存储两种类型的数据：
* TPM架构定义的数据结构。
* 用户或者平台相关的规范定义的非结构性数据。

TPM非易失性内存的一个应用是用于存储架构或者TPM软件规范定义的数据。这些数据包括授权值，种子，凭据以及TPM从不会暴露在安全边界之外的私有数据。除此之外，这些数据还包括计数器，时钟，以及其他用户可以读取的数据。非易失性内存也可以用于存储被配置成持续性的数据结构，比如秘钥。

本小节我们将介绍NV内存的另外一个使用案例：作为平台或者用户自定义的内存空间。因为是用户为每一个区域分配一个索引并使用这个索引来访问数据，所以有时候这又被称为用户自定义索引。

TPM1.2中包含可以存储自定义数据的用户索引。索引的大小和属性由用户来决定。用户可以不受限制地向索引的内存区域写数据。TPM为这些索引提供授权机制，可以提供基于HMAC，PCR，locality，和物理存在（physical presence）的访问控制；另外TPM提供索引的读写锁定机制。

TPM2.0在以下几个方面TPM1.2NV相关的特性：
* 一个索引有一个状态叫做“未初始化的，没有被写过”。在第一次写操作之前的读操作都将失败。更进一步，索引不能被用于policy。这样可以向这个索引的使用者保证这个索引的值一定是被具有授权权限的一方初始化过的，而不是简单默认值或者未初始化值。
* 与其他受保护的实体一样，TPM2.0的索引可以有授权值或者policy。
* 另外一个policy可以包含一个NV索引的值。这个policy可以对索引或者索引的一部分设定一个操作：比如跟policy数据对比。操作包括相等，不相等，有符号比较，无符号比较，以及检查某一位置位或者清零。

NV索引的另外一个新特性是数据类型。TPM2.0在1.2版本的非结构化数据（现在叫做普通数据）的基础上增加了另外三种类型，所以一共有四种类型：
* 普通。
* 计数器。
* 位域。
* 扩展。

## 普通NV索引
一个普通的NV索引和TPM1.2的索引类似。它用于存储任意长度的非结构化数据。与计数器，位域，以及扩展索引不同的是，普通NV索引对所写入的数据类型没有限制。

```
应用案例：存储一个秘密信息

假设一个平台包含一个必须在早期系统启动阶段可用的20字节长的秘密信息。这个信息可以被存储在一个NV索引中。索引的属性被设置为TPMA_NV_PPREAD，这表示读取这个索引需要平台授权。在系统启动早期运行的平台软件知道平台的授权信息，所以这些软件可以读取这个秘密信息。这同时也确保一旦启动软件完成启动任务之后这个秘密信息再也不会被读取。因为系统启动之后的其他软件并不知道平台授权信息，也就不能读取秘密信息了。

上述案例中TPM相关的命令如下：
* TPM2_NV_DefineSpace：创建一个普通的索引，NV内存大小为20字节，并且需要平台授权读写。
* TPM2_NV_Read：使用平台授权信息读取信息。
```

```
应用案例：存储一个证书

一个平台OEM厂商会创建一个证书，这个证书会声明平台有一个固定的背书密钥，并且平台具备一定程度的安全保证。OEM会在平台生成阶段将证书存储在NV中。其中，这个NV区域的读操作是不受限制的。但是写操作需要OEM的policy，它用于OEM安全地更新证书。

涉及的TPM命令如下：
* TPM2_NV_DefineSpace：创建一个普通NV索引，大小与证书大小相等，写操作需要平台授权，读操作授权是一个空口令。
* TPM2_NV_Write：使用平台授权（policy）。
* TPM2_NV_Read：使用空口令授权。
```

```
应用案例：存储一个通用的口令

一个用户使用同一个policy创建了一组密钥，当提供一个NV索引的授权口令时可以使用这些密钥。这样用户可以通过提供一个正确的口令来授权所有密钥的访问。同时用户只需要对NV区域做一次写操作就可以修改所有相关密钥的口令。

涉及的TPM命令如下：
1. TPM2_NV_DefineSpace：普通索引，大小为0，因为这个应用案例中并不会实际使用NV内存，设置NV索引的授权值为一个通用口令，也就是用于修改密钥授权值得policy口令。
2. 创建一个通用policy：执行TPM2_PolicySecret，并用NV索引的名称作为参数。
3. TPM2_Create：使用这个通用的policy创建多个密钥。userWithAuth属性为清除状态，这样就强制使用policy来授权密钥使用。
4. TPM2_NV_ChangeAuth：使用当前NV索引的口令来一次性修改所有密钥的授权值。
```

```
应用案例：存储一个密钥树根节点的公钥

IT管理员可以将一个公钥的哈希值存储在NV中，这个NV可以被写锁定，从而防止其他用户修改。这个哈希值用于验证另外一个公钥，这“另外一个公钥”又进一步用于验证一些签名确实来自于这个IT组织。所以，这个NV中存储的是一个证书链中根证书的公钥的哈希值。

涉及的TPM命令如下：
1. IT组织创建一个签名密钥，并对它的公钥做哈希。
2. 创建一个读操作的policy：TPM2_PolicyCommandCode指定TPM2_NV_READ命令。这个policy允许任何人读取NV索引的信息，并且不用提供任何授权信息。
3. TPM2_NV_DefineSpace：同样也是一个普通的索引，大小为哈希的大小，授权值为IT管理员的口令，口令用于写授权，读操作使用上述的policy。
4. TPM_NV_Write：使用IT管理员的授权口令授权NV写操作，将公钥的哈希值写入NV。

如下是验证签名时的操作：
1. TPM2_NV_Read命令读取公钥的哈希值。
2. 验证根证书中公钥的哈希值（在一个应用中，被验证的实体中会包含一个完整的证书链）。
3. 使用公钥来验证签名。
```

```
应用案例：存储一个HMAC密钥

在Linux系统的完整性测量架构（Integrity Measurement Architecture）的扩展验证模块（Extended Verification Module）中存储了一个HMAC密钥，这个密钥在启动早期就释放给内核，然后内核使用它验证文件的扩展属性。主要目的是看这些文件是否允许被内核加载或者使用。

涉及的TPM命令如下：
* TPM2_NV_DefineSpace：普通NV索引，大小等于HMAC密钥的大小，IT管理员口令用于写操作，读操作仍然使用上一个案例中使用的任何人可以不用授权就读的policy。
* TPM2_NV_Write：使用IT管理员口令授权NV写操作，将HMAC密钥存储到NV中。
* TPM2_NV_Read：读取HMAC密钥。
```
### NV计数器索引
### NV位域索引
### NV扩展索引
### 混合索引
### NV访问控制
### NV写操作
### NV索引的handle值
### NV名称
### NV口令
## NV相关的命令
## 总结
