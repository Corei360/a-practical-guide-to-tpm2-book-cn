# 加密解密会话
2B or not 2B, that is the question
                                
				 --Dave Challener，在TCG TSS工作组讨论加密解密会话期间。

第13章简单地介绍了加密和解密会话。你可能还记得，这些都是单个命令相关的修饰符。这一章将会详细介绍这两个会话修饰符：它们用来做什么，它们的实际应用，它们的一些限制，怎样设置它们，以及一些代码示例。

## 加密解密会话是做什么用的？
简单来说，加密解密会话保护秘密信息在不安全的信息传输媒介中传送。命令调用者为了保证数据的机密性，可以使用一个他和TPM都知道的加密秘钥来加密密令参数。加密秘钥部分由启动会话的参数决定（稍后介绍更多）。一个解密会话之后会通知TPM第一个参数被加密了。这就意味着TPM受到命令的参数后必须解密它——比如名称，解密会话。对于一个命令响应来说，一个加密会话表明TPM已经加密了第一个命令响应参数，这也是会话称作加密会话的原因。调用者在受到加密的命令响应参数后，他会使用命令响应参数解密秘钥来解密数据。

加密解密会话支持两种类型的对称秘钥模式：XOR和CFB。CFB模式的安全强度较高，但是这需要TPM和命令调用者需要支持哈希算法和加密算法。XOR仅仅要求支持哈希算法，并且适合小型代码工程，但是安全性相对较低。

## 实际的应用案例
所以，到底这些加密的模式有什么好处呢？简单快速的回答就是它们有很多用处；参考TPM2.0规范的第3部分中每个包含TPM2B数据作为第一个命令或者命令响应参数的命令。所有这些参数都有可能被加密。

一些小的通用案例如下：
* TPM2_Create：第一个命令参数inSensitive，这是一个包含口令的数据结构（叫做userAuth）。这个参数很可能以加密的方式发送到TPM，这就要求会话被配置为解密会话。
* 写入或者读出TPM NV索引区域的机密数据。假设你想使用TPM NV索引存储区域保存口令和个人信用卡等信息。在发送到TPM或者从TPM接受之前将这些数据加密可以保护它们不被泄露。
* 当我们通过网络与一个远程TPM通信时，使用加密解密会话就显得更加重要。假设你想把秘钥存储到远程服务器，然后在客户端上恢复它们。以明文的方式发送到服务器显然是不安全的。SSL会话可以缓解网络监听的缺点，但是秘钥仍然会以明文存在于客户端和服务器上的多层软件中。加密解密会话可以大大减小攻击面。

## 加密解密的限制
机密解密会话对参数的加密解密有一定的限制，同时一个命令对加密解密会话的数量也有限制。

只有命令的第一个参数可以被加密，并且只有命令响应的第一个参数可以被解密。并且在这两中前提下，参数还必须是TPM2B类型的参数。第一个参数不是TPM2B类型的命令不能使用机密会话发送到TPM；同样地，第一个参数不是TPM2B类型的命令响应也不能通过加密会话接受。

你已经在第13章中学过，命令可以有三个会话参数。但是，一个命令最多只能由一个加密会话和一个解密会话。如果一个命令同时允许使用解密和加密会话，可以使用具有两种属性的会话或者两个独立的会话（一个会话分别配置一个属性）。

所以我们到底怎样使能加密解密会话呢？

## 加密解密配置
### 伪码流
### 示例代码
## 总结
