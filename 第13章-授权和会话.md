# 授权和会话
授权和会话是TPM2.0规范中最重要的概念之一。授权用于控制TPM实体的访问，它为TPM提供了很多安全保证。会话是授权的引擎，并且也会维护多个命令之前的状态。除此之外，会话还用于配置一些命令相关的属性，比如说密令和命令响应参数以及审计的加密和解密操作。这一章介绍会话是因为他们与实体的授权动作相关。第16，17章将介绍命令会话相关的会话使用修饰符细节。

授权和会话是一个范围很大的话题，所以这张将会按照以下的过程介绍：
1. 授权你将学习针对授权和会话的新概念。
2. 你将会从较高的层次了解口令，HMAC，和policy授权，同时还有它们各自的安全属性。
3. 这一章会澄清会话和授权的异同，同时还有一些可能让人混淆的规范文档中的内容。
4. 你将深入学习授权的放方方面面，它们都适用于以下三种授权：口令，HMAC，以及Policy。你将会学习授权角色，以及命令和命令响应字节流中的授权区域。
5. 你将会详细的研究不同授权类型，从最简单到最复杂的口令，HMAC和Policy。介绍完口令授权以后，你将会首先了解一些HMAC和Policy授权的共同点，然后分别介绍这两种授权的详细内容。
6. 最后，所有的授权类型组合到一起形成混合型授权生命周期。

这一章不会描述各种各样的Policy授权命令。也不会介绍加密，解密和审计会话，只是提醒读者会话是这些操作的引擎。

这一章会使用图表，逻辑流，以及可以运行的代码示例来描述授权和会话是怎样工作的。这些材料是理解TPM2.0的基础。准备好艰难但会收获满满的学习旅程吧。

## 会话相关的定义
在我们深入挖掘授权和会话这个主题之前，我们需要清楚地理解一些新的概念。这些概念不在我们第5章介绍的概念范围之内。在阅读本章后续的内容时需要参考第5章的概念以及以下几个新的概念：
* 会话创建的变量：这些变量是在会话创建时设置的，并且会在会话生命周期内一直存在。它们用于决定会话和HMAC密钥是怎样创建的，以及HMAC是怎样生成的。一共有两种选择：bound和unbound，以及salted和unsalted。这两种选择的组合构成了四个会话变种。后续我们会详细地介绍它们。现在我们仅仅做一些概括的介绍：
  * Bound会话实际上就是将授权与一些实体的授权值绑定。这个绑定是通过将被绑定实体的授权值加入到会话密钥创建过程中。这个会影响到所有依赖会话密钥的计算，包括HMAC，policy，加解密计算。
  * 一个Unbound会话就是在会话密钥生成过程中不使用其他实体的授权信息。
  * 一个Salted会话会增加额外的熵值，这个盐，会被加入到会话密钥创建过程中；这与bound会话，它也同样会影响到依赖会话密钥的计算。这个额外的熵值是以加密的形式被发送到TPM设备中的，加密过的盐参数会被TPM2_StartAuthSession命令使用。
  * 一个Unsalted会话就是创建会话时不加入额外的熵值。
* 会话使用修饰符：这些修饰符会改变HMAC和Policy会话在一次命令中的行为。Continue，encrypt，decrypt，以及audit是比较常用的几种修饰符：
  * Continue：如果不设置，这个会话在命令执行成功后就会终止。
  * Decrypt：用于指示发送到TPM设备的第一个TPM2B命令参数是加密过的。
  * Encrypt：用于指示TPM设备将发送过来的命令响应的第一个TPM2B参数进行加密。
  * Audit：指示命令使用这个会话的命令要被审计。
在以上概念的基础上，我们就可以描述不同类型的会话了。

## 口令，HMAC，和Policy会话：它们都是什么？
所有这三种会话都是执行授权动作的方式，在HMAC和Policy会话都是基于单词命令来配置会话的。口令会话是最简单的授权类型：一个明文口令会被传递到TPM设备中用于授权一个一个动作。如果TPM是以远程的方式来访问的，这显然会有安全性的问题；口令授权的初衷就是用于本地访问。在TPM设备中有一个单一的，永远可用的口令会话用于授权一个单独的TPM命令，会话不会保存两次命令之间的任何状态。正因为如此，口令会话从来不需要被启动。

HMAC授权是一种更安全地使用口令的方式；一旦应用程序和TPM设备针对口令达成一致（这是在实体被创建或者实体的授权值被修改时形成的一种共识）后，就再也不需要传输口令了。而在创建实体或者修改实体授权信息时的一次性口令传输也可以以一种安全的方式完成：那就是口令可以用加密形式传输。一个HMAC会话可以把口令（这个口令在TPM2.0规范中叫做authValue）作为命令和响应计算HMAC时的一个输入参数，从而时授权达到一个很高的安全级别。在执行一个命令时，调用命令的应用程序会计算HMAC值并将这个值插入到命令字节流中。当TPM收到这个命令字节流后，如果TPM判定HMAC被正确地计算，那么相应的动作就被授权。在响应一个命令时，TPM会计算响应数据的HMAC值然后将这个值插入到响应字节流中。调用命令的应用程序收到命令响应数据流后会再单独计算一次HMAC，然后再与响应字节流中TPM计算的结果对比。如果这两个值匹配，那么响应数据就是可信的。所有的这些过程都是建立在应用程序和TPM都知道并且达成共识的authValue之上的。

HMAC会话会用到两个随机数，又叫作nonce，一个来自于调用者（nonceCaller），另外一个来自TPM（nonceTPM），这两个随机数可以用于防止重放攻击。随机数会用于HMAC的计算中。因为nonceTPM在每次执行命令时都会改变，调用命令的应用程序如果愿意的话也可以在每次执行命令的时候修改nonceCaller，所以攻击者就不能重复使用命令数据流。重复使用的命令字节流用于HMAC计算时一定会失败，这是因为随机数（确切的说是nonceTPM？）在重复使用时会变化。

HMAC会话会维护会话生命周期内的状态，因此会话可以用于针对TPM实体的多个动作。启动一个HMAC会话使用TPM2_StartAuthSession命令。当启动会话时，它可以被配置为bound vs. unbound以及salted vs. unsalted会话。这两种选择的组合构成了四种HMAC会话的变量；这四个变量决定了会话密钥和HMAC如何被创建。

Policy会话，又被称作增强的授权（Enhanced Authorizaiton），是建立在HMAC会话的基础上的，并且增加了额外的授权级别。HMAC授权仅仅使用授权值或者口令，然而Policy授权在此基础上做了增强，它可以根据TPM命令的顺序，TPM状态，以及外部设备如指纹读卡器，视网膜扫描器，和智能卡等信息来做授权。许多这些授权条件可以通过AND和OR操作组合成复杂的授权树，从而提供无限多的授权可能。

表13-1全局性地总结了各种类型的授权方式。

表13-1。

在此基础上，我们接下来了解一下规范在使用会话和授权时的细微差别。这里请注意；理解这些差别将极大地增加你阅读和理解TPM2.0规范以及本章后续章节的能力。

## 会话的授权：对比与差别
会话和授权是紧密相连的，并且有时候在TPM2.0规范中是重叠的，但是它们并不是相同的概念。会话是执行授权的引擎，但是会话还会用于授权之外的目的，这可能是与授权结合或者是完全独立于授权。比如说，用于授权的会话也可以被用于指定命令修饰符，如encrypt，decrypt，以及audit。会话也可以仅仅被用于指定这些修饰符而不做任何授权。

TPM2.0规范本身经常会重叠使用会话和授权这两个概念。如下是一些规范中的示例：
* 命令中的授权区域会用于授权和会话。但是会话可能以一种与授权完全不相关的方式被使用。比方说，它们可以用于加密和解密命令以及命令响应的参数，以及用于使能命令的审计。所以，与授权完全不相关的会话可能因为上述这些目的而被建立。
* TPM_ST_NO_SESSIONS和TPM_ST_NO_SESSIONS这两个标签被用于指示一个命令中是否包含授权区域，这显然缺乏命名上的一致性。
* 会话使用TPM2_StartAuthSession命令来启动。这个命令的名称表明一个授权过程被启动了，但是实际上是一个会话被启动了。然而这个刚刚启动的会话可能根本不会用于授权。
* 另外一个案例是口令授权。技术上说这些过程是会话，但是命令之前没有维护任何状态，并且TPM2_StartAuthSession并没有用于启动口令会话。一个口令授权就是一个一次性的授权方式，它仅仅对一次命令有效。

提醒你注意以上这些方面是为了有助于你理解规范。理解这些模糊的应用之间的区别曾经帮助我理解这些概念。最终我制作了一个图表将各种类型的授权，会话，以及会话修饰符归类。希望这个也可以帮到你。

图13-1 授权和会话的韦恩图

以下几点是针对这个图表的特殊提醒：
* 授权可以是口令，HMAC，或者是Policy授权。
* 口令授权不能被用于会话使用修饰符中。
```
注意：在图13-1中，审计，加密或者解密仅仅是展现出来的会话使用修饰符，还有其他的没有表现出来。展现着三种修饰符是因为他们通常更加常用。
```
* HMAC和Policy会话可以被用于授权，但是也可以被用于设置会话应用修饰符并且跟授权完全无关。这也是图中HMAC和Policy会话的区域越出“授权”圆形边界的原因。
* 命令的“授权区域”包含了所有的授权操作，会话，以及指定的会话修饰符。
* 命令修饰符可以在用于授权的会话中使用，也可以在不用于授权的会话中使用，这也是审计，加密，和解密圆形区域越出授权圆形边界的原因。
* 即使不是用于授权的会话也可以出现在命令和命令响应的授权区域内。
* Policy会话可以被用于加密，解密，但不能用于审计（根据TPM2.0规范开发者的说法，这样做是出于优化的原因，而非任何基础性的技术困难）。
* HMAC会话可以被用于加密，解密，以及审计。

图13-2 授权和会话框图

图13-2以不同的角度描绘了他们之间关系。关于这个图表，需要注意一下几点：
* 授权区域可以指定用于口令，HMAC，或者Policy会话的参数。授权区域将会在下一个小节中详细介绍。
* 使用TPM2_StartAuthSession命令启动的会话可以是HMAC，Policy，或者测试（trial）Policy会话。
* HMAC会话可以根据单个命令配置成audit，decrypt和encrypt会话。
* Policy会话可以根据单个命令配置成decrypt和encrypt会话。不能用于audit。
* 图示的四种会话初始化变量可以应用于HMAC，Policy，或者Trial Policy会话中。

需要记住的重要一点是，会话时执行授权操作的引擎，但是会话也可以用于授权无关的单次命令动作，这些动作是通过会话修饰符来设置的。

先不考虑会话是怎样被使用的，或者授权的类型，如果有授权或者会话，这些数据都是通过命令和命令响应的授权区域来输入和输出TPM设备的。在我介绍命令和命令响应区域之前，你需要先明白授权角色的功能。

## 授权角色
TPM2.0规范的第3部分对每一个命令的描述中都有指定授权角色。这角色和角色相关的规则与计算机文件夹的ACLs（Accessd Control Lists）的工作方式类似。授权角色控制着与命令执行相关的授权的类型，实际上也就是控制着谁可以在什么情况下执行哪些命令。

一共有三种可能的授权角色：USER，ADMIN，和DUP。USER用于TPM实体的正常使用。ADMIN用于系统管理相关的任务。DUP，一个狭隘的角色，是TPM2_Duplicate命令允许的角色。

用于决定一个TPM实体授权类型的两个属性是userWithAuth和userWithPolicy。这些属性既可以在创建对象的时候显式地指定，也可以通过特定的永久性handle和NV索引来决定：
* userWithAuth：
  * 置为1表示USER角色的授权可以通过口令，HMAC，或者Policy会话提供。
  * 置为0表示USER角色的授权必须通过Policy会话提供。
* adminWithPolicy：
  * 置为1表示ADMIN角色的授权必须通过Policy会话提供。
  * 置为0表示ADMIN角色的授权可以通过口令，HAMC，或者Policy会话提供。

如果一个命令的授权角色是ADMIN：
* 对于TPM对象的handle来说，需要的授权由这个对象的adminWithPolicy属性决定，这个属性是在对象创建的时候设置的。
* 对于TPM_RH_OWNER，TPM_RH_ENDORSEMENT，以及TPM_RH_PLATFORM这些handle来说，它们的授权相当于adminWithPolicy置为1。也就是说必须通过Policy会话提供授权。
* 对于NV索引来说，它们的授权相当于创建NV索引时将adminWithPolicy这个属性置为1。

如果一个命令的授权角色是USER：
* 对于TPM对象的handle来说，需要的授权由这个对象的userWithAuth属性来决定，这个属性是在创建对象的时候设置的。
* 对于TPM_RH_OWNER，TPM_RH_ENDORSEMENT，以及TPM_RH_PLATFORM这些handle来说，它们的授权相当于userWithAuth置为1.
* 对于NV索引来说，它们的授权类型由如下的NV索引属性决定：TPMA_NV_POLICYWRITE，TPMA_NV_POLICYREAD，TPMA_NV_AUTHWRITE，以及 TPMA_NV_AUTHREAD。这些NV索引的属性是在创建NV索引时指定的。

如果一个命令的授权角色是DUP：
* 授权必须是Policy。
* DUP角色只能用于TPM对象。

如果授权角色是DUP或者ADMIN，索要授权的命令必须在Policy中指定（PolicyCommandCode）。

现在你应该已经理解了授权角色了，接下来让我们看一下授权区域。

## 命令和命令响应的授权区域详解
### 命令授权区域
### 命令授权结构体
### 响应授权结构体
## 口令授权：最简单的授权
### 口令授权的生命周期
### 创建一个使用口令授权的实体
### 修改已有实体的授权口令
### 使用一个口令授权
### 代码示例：口令会话
## 启动HMAC和Policy会话
### TPM2_StartAuthSession命令
### 会话密钥和HMAC密钥的详细信息
### TPM2_StartAuthSession命令的handle和参数指导
### 会话的变量
#### Salted vs. Unsalted
#### Bound vs. Unbound
#### 会话变种的应用案例
## HMAC和Policy会话的不同
## HMAC授权
### HMAC授权生命周期
#### 修改或者创建一个使用HMAC授权的实体
#### 创建一个HMAC会话
#### 使用HMAC来授权单独地一次命令
### HMAC和Policy会话的代码示例
### 使用HMAC会话来发送多次命令（Rolling Nonces）
### HMAC会话的安全性
### HMAC会话的数据结构
## Policy授权
### EA是怎样工作的？
### Policy授权的时间间隔
### Policy授权的生命周期
#### 创建实体的Policy摘要
#### 使用Policy摘要创建一个实体
#### 开启一个真正的Policy会话
#### 发送Policy相关的命令来满足Policy
#### 执行需要Policy授权的动作
## 符合的授权生命周期
## 总结
