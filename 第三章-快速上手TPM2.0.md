# 快速上手TPM2.0
这一章主要描述TPM的应用。因为TPM2.0继承了TPM1.2中已有的功能，所以我们首先介绍TPM1.2的相关特性及其应用。然后我们进而介绍TPM2.0中新增加的特性和典型应用场景。

我们在第一章中已经提到，随着互联网的兴起，解决随之而来的安全问题，特别是解决电子商务中的安全问题是设计TPM的主要驱动力。一个基于硬件的标准的安全解决方案是当下迫在眉睫的需求。与此同时，因为没有历史包袱，所以这对安全研究者来说是一个从头到尾设计一个全新安全系统的黄金契机。长期以来，人们都期待一个基础性的安全架构，它能用于支撑新的安全技术的建立，而不是仅仅为了解决安全问题的安全补丁。

TCG在TPM1.2的设计中第一次尝试解决以下工业界中常见的问题：
* 设备身份：在TPM发布之前，设备通常用MAC地址和IP地址作为自己的身份，这并不安全。
* 密钥的安全生成：具备一个硬件随机数生成器对密钥的生成是非常有利的。许多安全解决方案因为密钥生成的质量不高而被破解。
* 密钥的安全存储：TPM能够安全存储高质量的密钥并让它们免于软件攻击，这是TPM带给设备的一个重大安全优势。
* NVRAM存储：当IT组织收到一个全新设备时，它们常常根据自己的标准流程格式化硬盘并重新部署软件。NVRAM可以让TPM一直保存证书而不依赖外部存储。
* 设备健康认证：在TPM出现之前，IT通常使用软件来检测系统的健康（安全）状态。但是，当整个软件系统被攻破的情况下，软件的报告就不可信赖了。

TPM2.0在1.2版本的基础上又增加了更多：
* 算法灵活性：因为有些算法的强度实际上比预期弱，所以未来可能需要修改。TPM2.0可以在不用修改规范前提下修改算法，这一点已经多次提到了。
* 增强的授权模式：这个功能通过增加授权策略的方式统一了TPM实体的授权方式。授权策略可以支持多元素多用户认证。除此之外，还包括策略管理的功能。
* 快速密钥加载：密钥加载是一个很费时的过程，因为密钥常常被加密存储。新的TPM规范使用对称密钥来加密密钥，相对于之前的非对称密钥加密，速度大大提高。
* 更稳定的PCR：过去，将密钥和设备状态绑定（状态常常由PCR存储，这里绑定可以简单理解为只有当某个PCR的值是某一个已知的好的状态时，才允许访问密钥）在一起会引起一些管理上的问题。因为通常情况下，假设一个密钥和存储平台启动过程测量值的PCR绑定，当启动固件因为正常更新影响PCR的值时，相应的密钥就要修改或者重新绑定。这个问题在新版本的TPM中已经不是问题了。
* 灵活的管理功能：各种各样的授权被分门别类，满足了对TPM资源进行灵活管理的需求。
* 通过名称识别资源：TPM1.2中对资源的间接访问产生了安全隐患。这问题在新的规范中通过使用资源名称来解决，名称本身经过基于密码学的安全处理。

已有超过10亿符合TPM1.2规范的TPM被部署在计算机系统中，单从这一点来看，无疑TPM1.2时成功的。而TPM2.0在1.2基础上做了更进一步的扩展。目前许多厂商正在实现满足TPM2.0规范的TPM，并且已经在部署了（2018的现在，新发布的商用机中应该都是TPM2.0了）。除了硬件TPM，一些厂商也在开发软件实现的TPM（来来来，Intel KPT，IMB vTPM，GOOGLE等大厂产品了解一下）。

## TPM1.2应用场景
一般来讲，TPM2.0的设计能够胜任所有TPM1.2芯片能做的事情。因此，考虑到当前的应用软件可以在TPM2.0芯片上运行，我们首先来介绍已经应用TPM1.2功能的应用。

### 身份认证
TPM1.2作为第一代嵌入式安全芯片，第一个得到应用的预期的功能是设备身份功能。首先来介绍一下具有类似功能的智能卡。智能卡的芯片中嵌入了用来标识其身份的私钥。同时还有口令或者PIN码用于验证智能卡用户身份。私钥和口令共同实现了“你拥有什么”，“你知道什么”这两方面的认证。但是只要知道一个智能卡的口令或者PIN码，它就没有办法阻止被多个人使用。也没有一种方法使智能卡和一个特定的设备实现绑定，当然如果这个智能卡是用来代理个人用户身份而不是设备身份的时候，这对智能卡来说是一种优势，因为一个软件的用户很可能会在不同的机器上使用相同的软件服务，这样以来一张卡就可以解决认证问题（后面也有类似的说明）。

通过在个人电脑中植入私钥的方法，可以让设备拥有身份。这对于IT组织来说是是一个巨大的利好，因为这样可以很安全有效地管理软件的加载和实施安全防护（）。但是随着个人电脑变得越来越轻便，它在“你拥有什么”这方面的认证功能已经开始取代智能卡了。在实际的应用中，经常出现一个智能卡完成对一个用户的身份认证后被留在电脑上。这个例子的言外之意就是PC和智能卡经长一块儿被盗。最后的结果就是将这两者分开并没有什么用处（这个译者暂时持保留态度吧，毕竟在安全领域就是个小白。曾经也看到过intel人写关于ME的书中说，TrustZone不好，因为它运行的时候是是AP在跑，没有Intel ME使用的轻量级的独立CPU省电。这个我真是看不懂，呵呵呵。总之，还是要辨证的看问题吧，我就是对这个地方的描述评论一下，并没有任何否定TPM牛X的安全设计理念的意思）。

另一方面，如果一个密钥的授权口令是存储在个人电脑的安全芯片中的，而这个密钥用于个人身份的代理，那么可以肯定的是这个密钥不能仅仅存在于一个电脑上。因为很我们几乎可以肯定的说这个人会使用不同的设备。更进一步说，设备通常经过3-5年后就需要升级，因此需要一个灵活的管理方式把密钥由旧的平台迁移到新平台上。

根据前面的描述，这里引出两个嵌入式安全芯片的两个重要设计目标。那就是它需要一种可以代表设备身份的密钥，并且密钥不能移动到其他设备上。另外，它还需要用于代表个人用户身份的密钥，与前者相反的是，这个密钥必须可以安全复制到不同设备上。当设备不再被使用时，还要有删除这两种密钥的能力（这里补充一点，TPM2.0超级厉害的密钥管理功能都支持以上功能哦，不信我们走着瞧！）。

那么到底身份认证（此时需要脑补一下签名验签的过程和安全属性）有什么用呢？其实它有大量的应用，我们举例来说：
* 用于VPN认证一个设备的身份，决定是否授予设备代理网络的访问权限。这样以来，IT组织可以很确定只有公司拥有的设备可以访问公司的VPN网络资源。（如果设备中有公司的IT组织掌握的私钥，可以通过让设备签名一个消息，IT用公钥来验证签名的方式轻松搞定认证？）
* 用于VPN认证一个用户的身份，决定是否授予一个账户代理网络访问权限。这跟上一个是一样的道理，不再赘述。
* 用户用于签名电子邮件：如果设备中的一个私钥能够代表一个个人的身份，那么用这个私钥完成的签名也就可以被收信人用于认证发信人的身份。
* 用户用于向银行证明自己的身份：关于这一点，嗯，还是google一下银行U盾，双向身份认证来详细了解一下吧。
* 用户用于授权支付：可以阻止别人以自己的名义买东西。
* 用户用于向远程系统证明自己的身份：只有只有经过认证的的用户才能登陆远程系统。

### 加密
系统的嵌入式安全芯片的第二个应用案例是用于加密密钥，被加密的密钥则用于加密文件或者解密收到的加密文件。出口法规限制常常让安全芯片在实现加解密引擎上止步不前；但是安全芯片用于存储加密密钥是被允许的，所以安全芯片通常会包含这个功能。因为芯片本身已经具备了基于非对称密钥的签名验签功能，在此基础上增加仅仅需要加解密包含密钥的少量数据的功能，这并不需要很高的成本。

正如上文所述，一旦具备基础的运算能力，就可以实现以下应用场景：
* 加密设备上的文件和文件夹。
* 全磁盘加密。
* 为口令管理器提供口令加密功能。
* 加密远程存储的文件。

### 密钥存储

### 随机书生成器
### NVRAM存储
### 平台配置寄存器
### 隐私保护
## TPM2.0新增的应用场景
### 算法灵活性
### 增强的授权模式
### 快速密钥加载
### 更稳定的PCR
### 灵活的管理功能
### 通过名称识别资源
## 小结
